#!/bin/bash
# Usage: waitforpg
# expected ENV: POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USERNAME, POSTGRES_PASSWORD
# Description:
# Waits for postgres to be fully up and running

export PGPASSWORD=$POSTGRES_PASSWORD

# First, wait for PostgreSQL to be ready
probe_postgres() {
  echo "select 'ping';" | psql -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USERNAME}" postgres 2>/dev/null >/dev/null
  return $?
}

until probe_postgres; do
  echo "⏳ $(date) - waiting for PostgreSQL to be ready..."
  sleep 1
done

echo "PostgreSQL is ready, checking database..."

# Check if the specific database exists, create it if it doesn't
probe_database() {
  echo "select 'ping';" | psql -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USERNAME}" ${POSTGRES_DB} 2>/dev/null >/dev/null
  return $?
}

if ! probe_database; then
  echo "Database ${POSTGRES_DB} does not exist, creating it..."
  createdb -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USERNAME}" ${POSTGRES_DB}
  echo "Database ${POSTGRES_DB} created successfully"
else
  echo "Database ${POSTGRES_DB} already exists"
fi

echo "Connection to DB succeeded..."

unset PGPASSWORD
